<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin - INTERCODIGOS EPIIS</title>
    <meta name="description" content="Panel de administración para INTERCODIGOS EPIIS.">
    <meta name="keywords" content="intercodigos, EPIIS, fútbol, torneo, admin">
    <meta name="author" content="INTERCODIGOS Team">
    <link rel="icon" type="image/png" href="/favicon.png">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a1a2a 0%, #1a2333 50%, #0a1a2a 100%);
            color: #FFFFFF;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: #4fc3f7;
            font-size: 3.5em;
            font-weight: 900;
            text-transform: uppercase;
            text-shadow: 0 0 20px #4fc3f7, 2px 2px 8px #1a2333;
            margin-bottom: 40px;
            letter-spacing: 3px;
            position: relative;
        }

        .admin-badge {
            background: linear-gradient(45deg, #FF0000, #FF6666);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.4em;
            position: absolute;
            top: -20px;
            right: -50px;
            transform: rotate(15deg);
            box-shadow: 0 5px 15px rgba(255, 0, 0, 0.3);
        }

        .partido {
            background: linear-gradient(145deg, #1a2333 0%, #232f45 100%);
            border: 3px solid #4fc3f7;
            background-clip: padding-box;
            border-radius: 20px;
            padding: 25px;
            margin: 20px auto;
            max-width: 1000px;
            text-align: center;
            box-shadow: 0 10px 30px #4fc3f7, 0 0 20px #1a2333;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .partido::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, #4fc3f7, #00ff8841, #4fc3f7);
            z-index: -1;
            padding: 3px;
            border-radius: 20px;
        }

        .partido:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.4);
        }

        .partido-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .partido h3 {
            color: #fff;
            font-size: 1.6em;
            font-weight: bold;
            text-transform: uppercase;
            background: linear-gradient(45deg, #4fc3f7, #00ff88);
            padding: 10px 20px;
            border-radius: 10px;
            margin: 0;
            text-shadow: 1px 1px 8px #4fc3f7;
        }

        .estado-control {
            margin-left: 20px;
        }

        .estado-select {
            background: linear-gradient(145deg, #1a1a1a, #000000);
            color: #FFD700;
            border: 2px solid #4FC3F7;
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            outline: none;
        }

        .estado-select:focus {
            border-color: #FFD700;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }

        .vs {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px 0;
            gap: 20px;
        }

        .equipo {
            flex: 1;
            background: rgba(26, 26, 26, 0.9);
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #4fc3f7;
            color: #FFFFFF;
        }

        .equipo h4 {
            color: #4fc3f7;
            font-size: 1.3em;
            margin-bottom: 15px;
            text-transform: uppercase;
            text-shadow: 0 0 8px #4fc3f7;
        }

        .puntaje-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin: 15px 0;
        }

        .puntaje-display {
            font-size: 2.5em;
            color: #4fc3f7;
            font-weight: 900;
            text-shadow: 2px 2px 12px #4fc3f7;
            min-width: 60px;
            background: rgba(0,0,0,0.3);
            padding: 5px 15px;
            border-radius: 10px;
            border: 2px solid #4fc3f7;
        }

        .btn-puntaje {
            background: linear-gradient(45deg, #4FC3F7, #FFD700);
            color: #000;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .btn-puntaje:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 12px rgba(0,0,0,0.4);
        }

        .btn-puntaje:active {
            transform: scale(0.95);
        }

        .vs-text {
            color: #4fc3f7;
            font-size: 1.5em;
            font-weight: bold;
            text-shadow: 2px 2px 12px #4fc3f7;
            background: rgba(0,0,0,0.3);
            padding: 10px 20px;
            border-radius: 50%;
            border: 2px solid #4fc3f7;
        }

        .minuto-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }

        .minuto-display {
            font-size: 1.5em;
            color: #4FC3F7;
            font-weight: bold;
            background: rgba(0,0,0,0.3);
            padding: 5px 15px;
            border-radius: 10px;
            border: 2px solid #4FC3F7;
        }

        .detalles {
            display: none;
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
            margin-top: 25px;
            background: linear-gradient(145deg, #232f45, #1a2333);
            padding: 25px;
            border-radius: 15px;
            border: 2px solid #4fc3f7;
            text-align: left;
        }

        .detalles.show {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        .detalles-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .detalle-grupo {
            background: rgba(26,26,26,0.5);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #4fc3f7;
        }

        .detalle-grupo h5 {
            color: #4fc3f7;
            margin-bottom: 10px;
            font-size: 1.1em;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            gap: 8px;
            text-shadow: 0 0 8px #4fc3f7;
        }

        .detalle-grupo textarea {
            width: 100%;
            min-height: 80px;
            padding: 12px;
            background: rgba(255,255,255,0.1);
            border: 2px solid #4FC3F7;
            border-radius: 8px;
            color: #FFFFFF;
            font-family: inherit;
            resize: vertical;
        }

        .detalle-grupo textarea:focus {
            outline: none;
            border-color: #FFD700;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }

        .detalle-grupo textarea::placeholder {
            color: rgba(255,255,255,0.7);
        }

        .controles-partido {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn-accion {
            background: linear-gradient(45deg, #4fc3f7, #00ff88);
            color: #000000;
            border: none;
            padding: 12px 25px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1em;
            text-transform: uppercase;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px #4fc3f7;
        }

        .btn-accion:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 18px rgba(0,0,0,0.4);
        }

        .btn-eliminar {
            background: linear-gradient(45deg, #FF0000, #FF6666) !important;
            color: white !important;
        }

        .btn-eliminar:hover {
            background: linear-gradient(45deg, #CC0000, #FF3333) !important;
        }

        .botones-principales {
            text-align: center;
            margin: 40px 0;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .btn-principal {
            background: linear-gradient(45deg, #4fc3f7, #00ff88);
            color: #000000;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.1em;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px #4fc3f7;
        }

        .btn-principal:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
        }

        .btn-principal i {
            margin-right: 8px;
        }

        .panel-section {
            display: none;
            max-width: 800px;
            margin: 40px auto;
            background: linear-gradient(145deg, rgba(255,255,255,0.1), rgba(0,0,0,0.1));
            padding: 30px;
            border-radius: 20px;
            border: 2px solid #4FC3F7;
            backdrop-filter: blur(10px);
        }

        .panel-section h2 {
            color: #FFD700;
            text-align: center;
            font-size: 2.5em;
            margin-bottom: 30px;
            text-transform: uppercase;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group.full-width {
            grid-column: span 2;
        }

        .form-group label {
            display: block;
            color: #FFD700;
            font-weight: bold;
            margin-bottom: 8px;
            text-transform: uppercase;
            font-size: 0.9em;
            letter-spacing: 1px;
        }

        input, select, textarea {
            width: 100%;
            padding: 15px 20px;
            margin: 5px 0;
            border: 2px solid #4FC3F7;
            border-radius: 15px;
            background: rgba(255,255,255,0.1);
            color: #FFFFFF;
            font-size: 1.1em;
            font-family: inherit;
            backdrop-filter: blur(5px);
        }

        input::placeholder, textarea::placeholder {
            color: rgba(255,255,255,0.7);
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #FFD700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
        }

        select {
            cursor: pointer;
        }

        select option {
            background: #1a1a1a;
            color: #FFFFFF;
        }

        #comentarios {
            list-style: none;
            padding: 0;
            max-height: 400px;
            overflow-y: auto;
        }

        #comentarios li {
            background: rgba(26, 26, 26, 0.8);
            padding: 15px 20px;
            margin: 10px 0;
            border-radius: 10px;
            border-left: 4px solid #4FC3F7;
            color: #FFFFFF;
            word-wrap: break-word;
        }

        #comentarios li:nth-child(odd) {
            border-left-color: #FFD700;
        }

        .no-data {
            text-align: center;
            color: #999999;
            font-size: 1.2em;
            margin: 50px 0;
            font-style: italic;
        }

        .mensaje-exito, .mensaje-error {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 10px;
            font-weight: bold;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        .mensaje-exito {
            background: linear-gradient(45deg, #00FF00, #32FF32);
            color: #000;
        }

        .mensaje-error {
            background: linear-gradient(45deg, #FF0000, #FF6666);
            color: white;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .file-upload {
            position: relative;
            display: inline-block;
            cursor: pointer;
            width: 100%;
        }

        .file-upload input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-upload-label {
            display: block;
            padding: 15px 20px;
            background: linear-gradient(45deg, #4FC3F7, #FFD700);
            color: #000;
            border-radius: 15px;
            text-align: center;
            font-weight: bold;
            text-transform: uppercase;
            transition: all 0.3s ease;
        }

        .file-upload:hover .file-upload-label {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        @media (max-width: 768px) {
            .detalles-grid, .form-grid { grid-template-columns: 1fr; }
            .vs { flex-direction: column; gap: 20px; }
            .partido-header { flex-direction: column; gap: 15px; }
            .estado-control { margin-left: 0; }
            .controles-partido { flex-direction: column; align-items: center; }
            .botones-principales { flex-direction: column; align-items: center; }
            .btn-principal { width: 80%; max-width: 300px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="botones-principales" style="margin-bottom:30px;">
            <button class="btn-principal" onclick="mostrarPartidos()"><i class="fas fa-home"></i> Partidos</button>
            <button class="btn-principal" onclick="mostrarCrear()"><i class="fas fa-plus-circle"></i> Crear Partido</button>
            <button class="btn-principal" onclick="mostrarFixture()"><i class="fas fa-calendar-alt"></i> Fixture</button>
            <button class="btn-principal" onclick="mostrarComentarios()"><i class="fas fa-comment"></i> Comentarios</button>
        </div>
        <h1>
            <i class="fas fa-cog"></i> ADMIN - INTERCODIGOS EPIIS
            <span class="admin-badge">ADMIN</span>
        </h1>
        <div id="partidos"></div>

    <div id="crear-partido" class="panel-section">
            <h2><i class="fas fa-plus-circle"></i> Crear Nuevo Partido</h2>
            <div class="form-grid">
                <div class="form-group full-width">
                    <label for="titulo">Título del Partido</label>
                    <input type="text" id="titulo" placeholder="Ejemplo: Semifinal 1, Final, Cuartos de Final..." />
                </div>
                <div class="form-group">
                    <label for="equipo1">Equipo 1</label>
                    <select id="equipo1">
                        <option value="">Selecciona el primer equipo</option>
                        <option value="Betas">Betas</option>
                        <option value="20-1">20-1</option>
                        <option value="20-2">20-2</option>
                        <option value="21-1">21-1</option>
                        <option value="21-2">21-2</option>
                        <option value="22-1">22-1</option>
                        <option value="22-2">22-2</option>
                        <option value="23-1">23-1</option>
                        <option value="23-2">23-2</option>
                        <option value="24-1">24-1</option>
                        <option value="24-2">24-2</option>
                        <option value="25-1">25-1</option>
                        <option value="25-2">25-2</option>
                        <option value="Docentes">Docentes</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="equipo2">Equipo 2</label>
                    <select id="equipo2">
                        <option value="">Selecciona el segundo equipo</option>
                        <option value="Betas">Betas</option>
                        <option value="20-1">20-1</option>
                        <option value="20-2">20-2</option>
                        <option value="21-1">21-1</option>
                        <option value="21-2">21-2</option>
                        <option value="22-1">22-1</option>
                        <option value="22-2">22-2</option>
                        <option value="23-1">23-1</option>
                        <option value="23-2">23-2</option>
                        <option value="24-1">24-1</option>
                        <option value="24-2">24-2</option>
                        <option value="25-1">25-1</option>
                        <option value="25-2">25-2</option>
                        <option value="Docentes">Docentes</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="estado-inicial">Estado Inicial</label>
                    <select id="estado-inicial">
                        <option value="En espera">En espera</option>
                        <option value="Jugando">Jugando</option>
                        <option value="Acabado">Acabado</option>
                    </select>
                </div>
            </div>
            <button class="btn-accion" onclick="crearPartido()">
                <i class="fas fa-save"></i> Crear Partido
            </button>
        </div>

    <div id="subir-fixture" class="panel-section">
        <h2><i class="fas fa-calendar-upload"></i> Subir Fixture</h2>
        <div class="form-group">
            <label>Seleccionar Imagen del Fixture</label>
            <div class="file-upload">
                <input type="file" id="fixture-imagen" accept="image/*" />
                <label for="fixture-imagen" class="file-upload-label">
                    <i class="fas fa-cloud-upload-alt"></i> Seleccionar Imagen
                </label>
            </div>
        </div>
        <button class="btn-accion" onclick="subirFixture()">
            <i class="fas fa-upload"></i> Subir Fixture
        </button>
        <hr style="margin:30px 0;">
        <h3 style="color:#FFD700;text-align:center;margin-bottom:20px;"><i class="fas fa-calendar-alt"></i> Imágenes de Fixture Subidas</h3>
        <div id="admin-fixtures-list" style="display:flex;flex-wrap:wrap;gap:20px;justify-content:center;"></div>
    </div>

    <div id="ver-comentarios" class="panel-section">
            <h2><i class="fas fa-comment-dots"></i> Comentarios del Público</h2>
            <ul id="comentarios"></ul>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>

let socket;
let loginEnCurso = false;
function conectarSocket() {
    if (socket && socket.connected) socket.disconnect();
    socket = io({
        auth: {
            token: localStorage.getItem('adminToken') || ''
        }
    });

    socket.on('connect', () => {
        console.log('✅ Admin conectado al servidor');
        loginEnCurso = false;
        mostrarPartidos();
    });
    socket.on('disconnect', () => {
        console.log('❌ Admin desconectado del servidor');
        mostrarMensajeError('Desconectado del servidor');
    });
    socket.on('error', (error) => {
        console.log('Error en la conexión', error);
        if (error && error.message && error.message.includes('Token')) {
            localStorage.removeItem('adminToken');
        }
    });
    socket.on('auth_required', (data) => {
        localStorage.removeItem('adminToken');
        mostrarMensajeError('Debes iniciar sesión como admin');
        if (!loginEnCurso) loginAdmin();
    });
}

if (localStorage.getItem('adminToken')) {
    conectarSocket();
} else {
    loginAdmin();
}


function loginAdmin() {
    if (loginEnCurso) return;
    loginEnCurso = true;
    const username = prompt('Usuario:');
    const password = prompt('Contraseña:');
    fetch('/api/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
    })
    .then(res => res.json())
    .then(data => {
        if (data.token) {
            localStorage.setItem('adminToken', data.token);
            window.location.reload();
        } else {
            mostrarMensajeError(data.error || 'Login fallido');
            loginEnCurso = false;
        }
    })
    .catch(err => {
        mostrarMensajeError(err.message);
        loginEnCurso = false;
    });
}

        function sanitizeInput(str) {
            return String(str).replace(/</g, "&lt;").replace(/>/g, "&gt;");
        }
        

        function ordenarPartidos(partidos) {
            const ordenEstado = { "Jugando": 1, "Pausado": 2, "En espera": 3, "Acabado": 4 };
            return partidos.slice().sort((a, b) => {
                let estadoDiff = (ordenEstado[a.estado] || 5) - (ordenEstado[b.estado] || 5);
                if (estadoDiff !== 0) return estadoDiff;
                return b.id - a.id;
            });
        }

        socket.on('partidos_update', (partidos) => {
            window.ultimoPartidos = partidos;
            const partidosDiv = document.getElementById('partidos');
            partidosDiv.innerHTML = '';
            if (!partidos || partidos.length === 0) {
                partidosDiv.innerHTML = '<div class="no-data"><i class="fas fa-info-circle"></i> No hay partidos creados</div>';
                return;
            }
            partidos = ordenarPartidos(partidos);
            partidos.forEach(partido => {
                const div = document.createElement('div');
                const estadoClass = partido.estado.toLowerCase().replace(' ', '-');
                const sanitizedTitulo = sanitizeInput(partido.titulo);
                div.className = `partido ${estadoClass}`;
                const estadoTexto = {
                    'En espera': 'POR JUGAR',
                    'Jugando': '🔴 EN VIVO',
                    'Pausado': '⏸️ PAUSADO',
                    'Acabado': 'FINALIZADO'
                };

                let tiempo = calcularCronometro(partido);

                div.innerHTML = `
                    <div class="partido-header">
                        <h3><i class="fas fa-trophy"></i> ${sanitizedTitulo}</h3>
                        <div class="estado-control">
                            <select class="estado-select" onchange="cambiarEstado(${partido.id}, this.value)" title="Cambiar estado del partido">
                                <option value="En espera" ${partido.estado === 'En espera' ? 'selected' : ''}>⏳ En espera</option>
                                <option value="Jugando" ${partido.estado === 'Jugando' ? 'selected' : ''}>🔴 Jugando</option>
                                <option value="Pausado" ${partido.estado === 'Pausado' ? 'selected' : ''}>⏸️ Pausado</option>
                                <option value="Acabado" ${partido.estado === 'Acabado' ? 'selected' : ''}>✅ Acabado</option>
                            </select>
                        </div>
                    </div>
                    <div class="vs">
                        <div class="equipo">
                            <h4>${sanitizeInput(partido.equipo1)}</h4>
                            <div class="puntaje-container">
                                <button class="btn-puntaje" onclick="restarPunto(${partido.id}, 'puntaje1')" title="Restar punto">
                                    <i class="fas fa-minus"></i>
                                </button>
                                <div class="puntaje-display">${partido.puntaje1 || 0}</div>
                                <button class="btn-puntaje" onclick="sumarPunto(${partido.id}, 'puntaje1')" title="Sumar punto">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                        <div class="vs-text">VS</div>
                        <div class="equipo">
                            <h4>${sanitizeInput(partido.equipo2)}</h4>
                            <div class="puntaje-container">
                                <button class="btn-puntaje" onclick="restarPunto(${partido.id}, 'puntaje2')" title="Restar punto">
                                    <i class="fas fa-minus"></i>
                                </button>
                                <div class="puntaje-display">${partido.puntaje2 || 0}</div>
                                <button class="btn-puntaje" onclick="sumarPunto(${partido.id}, 'puntaje2')" title="Sumar punto">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="estado-container">
                        <div class="estado ${estadoClass}"></div>
                        <div class="estado-texto">${estadoTexto[partido.estado] || partido.estado.toUpperCase()}</div>
                        <div class="minuto-container">
                            <span class="minuto-display" id="cronometro-${partido.id}">${tiempo}</span>
                            ${partido.estado === 'Jugando' ? `<button class="btn-accion" onclick="pausarPartido(${partido.id})"><i class='fas fa-pause'></i> Pausar</button>` : ''}
                            ${partido.estado === 'Pausado' ? `<button class="btn-accion" onclick="reanudarPartido(${partido.id})"><i class='fas fa-play'></i> Reanudar</button>` : ''}
                        </div>
                    </div>
                    <div class="detalles" id="detalles-${partido.id}">
                        <div class="detalles-grid">
                            <div class="detalle-grupo">
                                <h5><i class="fas fa-users"></i> Jugadores de <span id="nombre-equipo1-${partido.id}">${sanitizeInput(partido.equipo1)}</span></h5>
                                <textarea id="jugadores1-${partido.id}" placeholder="Ejemplo: Juan, Pedro, Luis...">${sanitizeInput(partido.jugadores1 || '')}</textarea>
                            </div>
                            <div class="detalle-grupo">
                                <h5><i class="fas fa-users"></i> Jugadores de <span id="nombre-equipo2-${partido.id}">${sanitizeInput(partido.equipo2)}</span></h5>
                                <textarea id="jugadores2-${partido.id}" placeholder="Ejemplo: Ana, María, Sofía...">${sanitizeInput(partido.jugadores2 || '')}</textarea>
                            </div>
                            <div class="detalle-grupo">
                                <h5><i class="fas fa-exclamation-triangle"></i> Sanciones</h5>
                                <textarea id="sanciones-${partido.id}" placeholder="Ejemplo: Tarjeta amarilla a Juan (min 15)...">${sanitizeInput(partido.sanciones || '')}</textarea>
                            </div>
                            <div class="detalle-grupo">
                                <h5><i class="fas fa-clipboard-list"></i> Observaciones</h5>
                                <textarea id="observaciones-${partido.id}" placeholder="Ejemplo: Partido jugado bajo lluvia...">${sanitizeInput(partido.observaciones || '')}</textarea>
                            </div>
                        </div>
                        <div class="controles-partido">
                            <button class="btn-accion" onclick="guardarDetalles(${partido.id})">
                                <i class="fas fa-save"></i> Guardar Detalles
                            </button>
                            <button class="btn-accion btn-eliminar" onclick="eliminarPartido(${partido.id})">
                                <i class="fas fa-trash-alt"></i> Eliminar Partido
                            </button>
                        </div>
                    </div>
                `;

                div.addEventListener('click', (e) => {
                    if (!e.target.closest('button') && !e.target.closest('input') && !e.target.closest('select') && !e.target.closest('textarea')) {
                        const detalles = document.getElementById(`detalles-${partido.id}`);
                        detalles.classList.toggle('show');
                    }
                });

                partidosDiv.appendChild(div);
            });
        });

        socket.on('comentarios_update', (comentarios) => {
            const comentariosUl = document.getElementById('comentarios');
            comentariosUl.innerHTML = '';
            if (!comentarios || comentarios.length === 0) {
                comentariosUl.innerHTML = '<li class="no-data"><i class="fas fa-info-circle"></i> No hay comentarios</li>';
                return;
            }
            comentarios.forEach(c => {
                const li = document.createElement('li');
                li.innerHTML = `<span>${c.texto.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</span> <button class='btn-accion btn-eliminar' style='float:right;' onclick='eliminarComentario(${c.id})'><i class='fas fa-trash-alt'></i></button>`;
                comentariosUl.appendChild(li);
            });
        });

        socket.on('partido_creado', (data) => {
            mostrarMensajeExito(`🎉 Partido "${data.titulo}" creado con ID: ${data.id}`);
            document.getElementById('titulo').value = '';
            document.getElementById('equipo1').value = '';
            document.getElementById('equipo2').value = '';
            setTimeout(mostrarPartidos, 1000);
        });

        function mostrarPartidos() {
            document.getElementById('partidos').style.display = 'block';
            document.getElementById('crear-partido').style.display = 'none';
            document.getElementById('subir-fixture').style.display = 'none';
            document.getElementById('ver-comentarios').style.display = 'none';
            socket.emit('solicitar_partidos');
        }

        function mostrarCrear() {
            document.getElementById('partidos').style.display = 'none';
            document.getElementById('crear-partido').style.display = 'block';
            document.getElementById('subir-fixture').style.display = 'none';
            document.getElementById('ver-comentarios').style.display = 'none';
        }

        function mostrarFixture() {
            document.getElementById('partidos').style.display = 'none';
            document.getElementById('crear-partido').style.display = 'none';
            document.getElementById('subir-fixture').style.display = 'block';
            document.getElementById('ver-comentarios').style.display = 'none';
        }

        function mostrarComentarios() {
            document.getElementById('partidos').style.display = 'none';
            document.getElementById('crear-partido').style.display = 'none';
            document.getElementById('subir-fixture').style.display = 'none';
            document.getElementById('ver-comentarios').style.display = 'block';
            socket.emit('solicitar_comentarios');
        }

        function crearPartido() {
            const titulo = document.getElementById('titulo').value.trim();
            const equipo1 = document.getElementById('equipo1').value;
            const equipo2 = document.getElementById('equipo2').value;
            const estado = document.getElementById('estado-inicial').value;

            if (!titulo) return mostrarMensajeError('Ingresa un título válido');
            if (!equipo1) return mostrarMensajeError('Selecciona el equipo 1');
            if (!equipo2) return mostrarMensajeError('Selecciona el equipo 2');
            if (equipo1 === equipo2) return mostrarMensajeError('Los equipos deben ser diferentes');

            socket.emit('crear_partido', { titulo, equipo1, equipo2, estado });
        }

        function cambiarEstado(id, estado) {
            socket.emit('update_partido', { id, estado });
            mostrarMensajeExito(`Estado cambiado a ${estado}`);
        }

        function pausarPartido(id) {
            socket.emit('update_partido', { id, estado: 'Pausado' });
            mostrarMensajeExito('Partido pausado');
        }

        function reanudarPartido(id) {
            socket.emit('update_partido', { id, estado: 'Jugando' });
            mostrarMensajeExito('Partido reanudado');
        }


        function calcularCronometro(partido) {
            let elapsed = partido.elapsed_time || 0;
            let segundos = elapsed;
            if (partido.estado === 'Jugando' && partido.start_time) {
                let start = new Date(partido.start_time).getTime();
                let ahora = Date.now();
                segundos += Math.floor((ahora - start) / 1000);
            }
            if (segundos > 10800) segundos = 10800;
            let h = Math.floor(segundos / 3600);
            let m = Math.floor((segundos % 3600) / 60);
            let s = segundos % 60;
            return `${h > 0 ? (h + ':') : ''}${(m < 10 && h > 0 ? '0' : '') + m}:${s < 10 ? '0' : ''}${s}`;
        }


        setInterval(() => {
            document.querySelectorAll('[id^="cronometro-"]').forEach(span => {
                const id = span.id.replace('cronometro-', '');
                const partido = window.ultimoPartidos?.find(p => p.id == id);
                if (partido) {
                    span.textContent = calcularCronometro(partido);
                }
            });
        }, 1000);


        let ultimoPartidos = [];
        socket.on('partidos_update', (partidos) => {
            window.ultimoPartidos = partidos;
        });

        if (typeof mostrarMensajeExito !== 'function') {
            function mostrarMensajeExito(msg) {
                const div = document.createElement("div");
                div.className = "mensaje-exito";
                div.textContent = msg;
                document.body.appendChild(div);
                setTimeout(() => div.remove(), 3000);
            }
        }
        if (typeof mostrarMensajeError !== 'function') {
            function mostrarMensajeError(msg) {
                const div = document.createElement("div");
                div.className = "mensaje-error";
                div.textContent = msg;
                document.body.appendChild(div);
                setTimeout(() => div.remove(), 3000);
            }
        }
        

        function sumarPunto(id, campo) {
            socket.emit('update_partido', { id, [campo]: 'sumar' });
            mostrarMensajeExito('Punto sumado');
        }

        function restarPunto(id, campo) {
            socket.emit('update_partido', { id, [campo]: 'restar' });
            mostrarMensajeExito('Punto restado');
        }

        function sumarMinuto(id) {
            socket.emit('update_partido', { id, minuto: 'sumar' });
            mostrarMensajeExito('Minuto sumado');
        }

        function restarMinuto(id) {
            socket.emit('update_partido', { id, minuto: 'restar' });
            mostrarMensajeExito('Minuto restado');
        }

        function guardarDetalles(id) {
            const jugadores1 = document.getElementById(`jugadores1-${id}`).value.trim();
            const jugadores2 = document.getElementById(`jugadores2-${id}`).value.trim();
            const sanciones = document.getElementById(`sanciones-${id}`).value.trim();
            const observaciones = document.getElementById(`observaciones-${id}`).value.trim();

            const nombreEquipo1 = document.getElementById(`nombre-equipo1-${id}`).textContent.trim();
            const nombreEquipo2 = document.getElementById(`nombre-equipo2-${id}`).textContent.trim();
            
            let jugadores = jugadores1 || jugadores2 ? `${jugadores1}|${jugadores2}` : '';
            socket.emit('update_partido', {
                id,
                jugadores1,
                jugadores2,
                jugadores,
                sanciones,
                observaciones
            });
	    mostrarMensajeExito('Detalles guardados');
        }

        function eliminarPartido(id) {
            if (confirm('¿Estás seguro de que quieres eliminar este partido?')) {
                socket.emit('eliminar_partido', id);
                mostrarMensajeExito('Partido eliminado');
            }
        }

        function subirFixture() {
            const fileInput = document.getElementById('fixture-imagen');
            const file = fileInput.files[0];
            if (!file) {
                mostrarMensajeError('Selecciona una imagen');
                return;
            }

            const formData = new FormData();
            formData.append('fixture', file);

            fetch('/upload-fixture', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                },
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                mostrarMensajeExito('Fixture subido exitosamente');
                fileInput.value = '';
                setTimeout(mostrarPartidos, 2000);
            })
            .catch(err => {
                mostrarMensajeError(err.message);
                if (err.message.includes('Token')) {
                    localStorage.removeItem('adminToken');
                    loginAdmin();
                }
            });
        }

        function mostrarMensajeExito(mensaje) {
            document.querySelectorAll('.mensaje-exito').forEach(msg => msg.remove());
            const mensajeDiv = document.createElement('div');
            mensajeDiv.className = 'mensaje-exito';
            mensajeDiv.innerHTML = `<i class="fas fa-check-circle"></i> ${mensaje}`;
            document.body.appendChild(mensajeDiv);
            setTimeout(() => mensajeDiv.remove(), 3000);
        }

        function mostrarMensajeError(mensaje) {
            document.querySelectorAll('.mensaje-error').forEach(msg => msg.remove());
            const mensajeDiv = document.createElement('div');
            mensajeDiv.className = 'mensaje-error';
            mensajeDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${mensaje}`;
            document.body.appendChild(mensajeDiv);
            setTimeout(() => mensajeDiv.remove(), 3000);
        }

        function eliminarComentario(id) {
            socket.emit('eliminar_comentario', id);
        }

        function eliminarFixture(id) {
            socket.emit('eliminar_fixture', id);
        }

        socket.on('fixture_update', function(fixtures) {
            const cont = document.getElementById('admin-fixtures-list');
            if (!cont) return;
            cont.innerHTML = '';
            if (!fixtures || fixtures.length === 0) {
                cont.innerHTML = '<div class="no-data"><i class="fas fa-info-circle"></i> No hay fixtures subidos</div>';
                return;
            }
            fixtures.forEach(function(f) {
                const div = document.createElement('div');
                div.style = 'position:relative;display:inline-block;background:#222;padding:10px;border-radius:10px;box-shadow:0 2px 8px #0008;';
                div.innerHTML = `<img src="/uploads/${f.imagen}" alt="Fixture" style="max-width:220px;max-height:220px;display:block;border-radius:8px;">`+
                `<button class='btn-accion btn-eliminar' style='position:absolute;top:8px;right:8px;padding:6px 10px;font-size:1em;' onclick='eliminarFixture(${f.id})'><i class='fas fa-trash-alt'></i></button>`;
                cont.appendChild(div);
            });
        });
    </script>
</body>
</html>
